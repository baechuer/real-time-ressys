# City Events Platform - BFF API Contract (v0.1)

> This document defines the **edge contract** exposed by the **Next.js BFF** to the **Browser**.
> The Browser **MUST NOT** call usage microservices directly. All traffic is proxied/aggregated by `/api/*`.

---

## 1. Unified Error Format
All API responses with HTTP status >= 400 MUST follow this structure.

```json
{
  "error": {
    "code": "resource_not_found",    // Stable error code (snake_case)
    "message": "Event not found",    // Human readable message (safe for UI toast)
    "request_id": "req-123-abc",     // For tracing/debugging
    "meta": {                        // Optional context
      "field": "email"
    }
  }
}
```

### Common Error Codes
| Code | HTTP | Description | UI Handling |
| :--- | :--- | :--- | :--- |
| `unauthorized` | 401 | Not logged in / Session expired | Auto-refresh or redirect to Login |
| `forbidden` | 403 | Logged in but no permission | Show "Access Denied" page/state |
| `validation_failed` | 400 | Bad input (see `meta`) | Show form errors |
| `conflict_state` | 409 | e.g. Already joined, Event full | Show error toast |
| `internal_error` | 500/502 | Server or Upstream error | Show generic "Try again later" |
| `upstream_timeout` | 504 | Service slow/down | Show retry toast |

---

## 2. Pagination (Cursor-based)
Used for Feeds and Lists.

### Request Parameters
*   `cursor`: (Optional) Opaque string from previous response `next_cursor`. If empty, start from beginning.
*   `limit`: (Optional) Number of items (default 20, max 50).

### Response Envelope
```json
{
  "items": [ ... ],       // Array of ViewModels
  "next_cursor": "...",   // Opaque string. NULL if no more pages.
  "has_more": true        // Convenience boolean
}
```

---

## 3. Endpoints

### 3.1 Auth
*   `POST /api/auth/register` (Proxy -> `auth-service`)
*   `POST /api/auth/login` (Proxy -> `auth-service`; Set-Cookie)
*   `POST /api/auth/refresh` (Proxy -> `auth-service`; Rotate Cookie)
*   `POST /api/auth/logout` (Proxy -> `auth-service`; Clear Cookie)
*   `GET /api/auth/me` (Proxy -> `auth-service`; Get User)

### 3.2 Feed & Events
#### `GET /api/feed`
The main home feed.
*   **Source (V0)**: Proxies to `event-service` Public List (FTS).
*   **Params**: `cursor`, `limit`, `q` (search), `city`, `category`.
*   **Response**: List of `EventCard`.

#### `GET /api/events/{id}`
The single event page.
*   **Source**: Aggregates `event-service` + `join-service` actions.
*   **Response (`EventView`)**:
    ```json
    {
      "event": {
        "id": "...",
        "title": "...",
        "start_time": "...",
        "location": { "city": "..." },
        "organizer": { "id": "..." }
      },
      "viewer_context": {
        "participation_status": "active" | "waitlisted" | "cancelled" | "none",
        "can_join": true,
        "can_cancel": false
      }
    }
    ```

### 3.3 Actions
#### `POST /api/events/{id}/join`
#### `POST /api/events/{id}/cancel`
*   **Header**: `X-Idempotency-Key` (Generated by frontend).
*   **Source**: Proxies to `join-service`.

---

## 4. View Models (Frontend Types)

### `EventCard` (List Item)
Optimized for rendering cards.
```typescript
interface EventCard {
  id: string;
  title: string;
  cover_image?: string; // Placeholder for now
  start_time: string;   // ISO8601
  city: string;
  category: string;
  score?: number;       // For debug/sorting
}
```

### `EventView` (Detail Page)
Includes full description and participation context.
```typescript
interface EventView {
  event: EventCard & {
    description: string;
    capacity: number;
    filled_count: number; // Statistic if available
    organizer_id: string;
  };
  viewer_context: {
    participation_status: 'none' | 'active' | 'waitlisted' | 'cancelled';
  };
}
```
