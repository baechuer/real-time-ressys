name: ci

on:
  pull_request:
  push:
    branches: ["main", "master"]

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        svc: [auth-service, event-service, join-service, email-service, bff-service, feed-service, media-service, media-worker]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
          cache: true
          cache-dependency-path: |
            services/${{ matrix.svc }}/go.sum

      - name: Unit tests
        working-directory: services/${{ matrix.svc }}
        run: |
          set -euo pipefail
          go mod download
          go test ./... -race

    env:
      JWT_SECRET: "test-secret"
      JWT_ISSUER: "self-project"
      INTERNAL_SECRET_KEY: "test-secret-key"


  integration-tests:
    runs-on: ubuntu-latest
    needs: [unit-tests]
    strategy:
      fail-fast: false
      matrix:
        include:
          - svc: auth-service
            compose_file: test/integration/infra/compose.yaml
            pg_dsn: "postgres://user:pass@localhost:54321/app"
            redis_addr: "localhost:63791"
            rabbit_url: "amqp://it:it@localhost:56731/"
          - svc: event-service
            compose_file: test/integration/infra/compose.yaml
            pg_dsn: "postgres://user:pass@localhost:5434/app?sslmode=disable"
            redis_addr: "localhost:6381"
            rabbit_url: "amqp://guest:guest@localhost:5675/"
          - svc: join-service
            compose_file: docker-compose.test.yml
            pg_dsn: "postgres://test_user:test_password@localhost:5433/join_service_test?sslmode=disable"
            redis_addr: "localhost:6380"
            rabbit_url: "amqp://test_user:test_password@localhost:5673/"
          - svc: email-service
            compose_file: test/integration/infra/compose.yaml
            # Email service doesn't use Postgres in integration test, but we can leave placeholder or empty
            pg_dsn: "" 
            redis_addr: "localhost:6382"
            rabbit_url: "amqp://guest:guest@localhost:5676/"

    env:
      # Common / Matrix
      IT_PG_DSN: ${{ matrix.pg_dsn }}
      IT_REDIS_ADDR: ${{ matrix.redis_addr }}
      IT_RABBIT_URL: ${{ matrix.rabbit_url }}
      TEST_INTEGRATION: "1"

      # Secrets
      JWT_SECRET: "test-secret"
      JWT_ISSUER: "self-project"
      INTERNAL_SECRET_KEY: "test-secret-key"
      VERIFY_EMAIL_BASE_URL: "https://frontend/verify-email?token="
      PASSWORD_RESET_BASE_URL: "https://frontend/reset-password?token="

      # Mappings for various services
      # Join
      TEST_DB_DSN: ${{ matrix.pg_dsn }}
      TEST_REDIS_ADDR: ${{ matrix.redis_addr }}
      TEST_RABBIT_URL: ${{ matrix.rabbit_url }}

      # Event & Auth
      DB_ADDR: ${{ matrix.pg_dsn }}
      DATABASE_URL: ${{ matrix.pg_dsn }}
      REDIS_ADDR: ${{ matrix.redis_addr }}
      REDIS_URL: "redis://${{ matrix.redis_addr }}/0"
      RABBIT_URL: ${{ matrix.rabbit_url }}
      
      # Event Service specific
      EVENT_BASE_URL: "http://localhost:8081"
      HTTP_ADDR: ":8081"

      # Email Service specific
      SMTP_PORT: "1026"
      MAILPIT_API_PORT: "8026"
      MAILPIT_API: "http://localhost:8026"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
          cache: false

      - name: Start integration infra
        working-directory: services/${{ matrix.svc }}
        run: |
          set -euo pipefail
          docker compose -f ${{ matrix.compose_file }} up -d --wait

      - name: Integration tests
        working-directory: services/${{ matrix.svc }}
        run: |
          set -euo pipefail
          echo "Running integration tests..."
          
          if [ -f "test/integration/run.sh" ]; then
            echo "Found run.sh, executing..."
            bash test/integration/run.sh
          elif [ -f "scripts/run_integration_tests.sh" ]; then
            echo "Found scripts/run_integration_tests.sh, executing..."
            bash scripts/run_integration_tests.sh
          elif [ -d "test/integration" ] || [ -d "internal" ]; then
             echo "No run script found, running go test directly..."
             go test -tags=integration ./... -count=1 -p=1 -v -timeout 5m
          else
             echo "No integration tests found"
          fi

      - name: Logs on failure
        if: failure()
        working-directory: services/${{ matrix.svc }}
        run: |
          docker compose -f ${{ matrix.compose_file }} logs --no-color

      - name: Down
        if: always()
        working-directory: services/${{ matrix.svc }}
        run: |
          docker compose -f ${{ matrix.compose_file }} down -v

  e2e-tests:
    runs-on: ubuntu-latest
    needs: [unit-tests]
    env:
      # Infrastructure secrets for docker-compose
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: postgres
      RABBITMQ_USER: guest
      RABBITMQ_PASS: guest
      RABBITMQ_VHOST: /
      # Service secrets
      APP_ENV: test
      JWT_SECRET: test-secret
      INTERNAL_SECRET_KEY: test-secret-key
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"

      - name: Start Full Stack
        run: |
          docker compose up -d --build --wait

      - name: Run E2E Tests
        working-directory: tests/e2e
        run: |
          # Ensure mod exists if not committed (robustness)
          if [ ! -f go.mod ]; then
            go mod init e2e
            go get github.com/stretchr/testify/assert github.com/stretchr/testify/require
          fi
          go test -v .

      - name: Logs on failure
        if: failure()
        run: docker compose logs --no-color

      - name: Down
        if: always()
        run: docker compose down -v

  k8s-smoke-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create k8s Kind Cluster
        uses: helm/kind-action@v1.8.0

      - name: Apply Manifests
        run: |
          set -e
          echo "Applying Namespace..."
          kubectl apply -f k8s/base/namespace.yaml

          echo "Applying Secrets (Template)..."
          # apply template logic to ensure secret exists for pods
          kubectl apply -f k8s/base/secrets-template.yaml

          echo "Applying Infrastructure..."
          kubectl apply -f k8s/infra/

          echo "Applying Apps..."
          kubectl apply -f k8s/apps/

          echo "Verifying resources created..."
          kubectl get all -n city-events
