version: "3.8"

include:
  - compose.infra.yml

networks:
  infra_default:
    external: true

services:
  # -------------------------------------------------------------------------
  # BACKEND SERVICES
  # -------------------------------------------------------------------------
  auth-service:
    build:
      context: ./services/auth-service
      dockerfile: Dockerfile
    ports:
      - "8081:8080"
    environment:
      - APP_ENV=dev
      - HTTP_PORT=8080
      - DB_DSN=postgres://postgres:postgres@postgres:5432/auth_db?sslmode=disable
      - REDIS_ADDR=redis:6379
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
    networks:
      - infra_default
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  event-service:
    build:
      context: ./services/event-service
      dockerfile: Dockerfile
    ports:
      - "8082:8080"
    environment:
      - APP_ENV=dev
      - HTTP_PORT=8080
      - DB_DSN=postgres://postgres:postgres@postgres:5432/event_db?sslmode=disable
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
    networks:
      - infra_default
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  join-service:
    build:
      context: ./services/join-service
      dockerfile: Dockerfile
    ports:
      - "8083:8080"
    environment:
      - APP_ENV=dev
      - HTTP_PORT=8080
      - DB_DSN=postgres://postgres:postgres@postgres:5432/join_db?sslmode=disable
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
    networks:
      - infra_default
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  email-service:
    build:
      context: ./services/email-service
      dockerfile: Dockerfile
    ports:
      - "8090:8090"
    environment:
      - APP_ENV=dev
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
      - SMTP_HOST=mailhog
      - SMTP_PORT=1025
    networks:
      - infra_default
    depends_on:
      rabbitmq:
        condition: service_healthy

  # -------------------------------------------------------------------------
  # API GATEWAY / BFF
  # -------------------------------------------------------------------------
  bff-service:
    build:
      context: ./services/bff-service
      dockerfile: Dockerfile
    ports:
      - "8080:8080" # Main API Entry
    environment:
      - APP_ENV=dev
      - HTTP_PORT=8080
      - AUTH_SERVICE_URL=http://auth-service:8080
      - EVENT_SERVICE_URL=http://event-service:8080
      - JOIN_SERVICE_URL=http://join-service:8080
    networks:
      - infra_default
    depends_on:
      - auth-service
      - event-service
      - join-service

  # -------------------------------------------------------------------------
  # FRONTEND
  # -------------------------------------------------------------------------
  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
    ports:
      - "3000:80"
    networks:
      - infra_default
