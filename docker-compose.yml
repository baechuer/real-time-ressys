version: "3.8"

include:
  - compose.infra.yml

services:
  # -------------------------------------------------------------------------
  # BACKEND SERVICES
  # -------------------------------------------------------------------------
  auth-service:
    build:
      context: ./services/auth-service
      dockerfile: Dockerfile
    ports:
      - "8081:8080"
    environment:
      - APP_ENV=${APP_ENV:-dev}
      - HTTP_ADDR=:8080
      - DB_ADDR=postgres://${POSTGRES_USER:?required}:${POSTGRES_PASSWORD:?required}@cityevents-postgres:5432/auth_db?sslmode=disable
      - MIGRATIONS_TABLE=schema_migrations_auth
      - REDIS_ADDR=cityevents-redis:6379
      - REDIS_DB=0
      - RABBIT_URL=amqp://${RABBITMQ_USER:-guest}:${RABBITMQ_PASS:-guest}@cityevents-rabbitmq:5672/
      - JWT_SECRET=${JWT_SECRET:?required}
      - INTERNAL_SECRET_KEY=${INTERNAL_SECRET_KEY:?required}
      - VERIFY_EMAIL_BASE_URL=${VERIFY_EMAIL_BASE_URL:-http://localhost:8080/auth/v1/verify-email/confirm?token=}
      - PASSWORD_RESET_BASE_URL=${PASSWORD_RESET_BASE_URL:-http://localhost:8080/auth/v1/password/reset/validate?token=}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - OAUTH_CALLBACK_URL=http://localhost:8080/api/auth/oauth/google/callback
      - FRONTEND_ORIGIN=http://localhost:5173
      - ALLOWED_REDIRECTS=/,/events,/profile
      - CDN_BASE_URL=${CDN_BASE_URL:-http://localhost:9000/public}
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/readyz" ]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  event-service:
    build:
      context: ./services/event-service
      dockerfile: Dockerfile
    ports:
      - "8082:8080"
    environment:
      - APP_ENV=${APP_ENV:-dev}
      - HTTP_ADDR=:8080
      - DATABASE_URL=postgres://${POSTGRES_USER:?required}:${POSTGRES_PASSWORD:?required}@cityevents-postgres:5432/event_db?sslmode=disable
      - MIGRATIONS_TABLE=schema_migrations_event
      - RABBIT_URL=amqp://${RABBITMQ_USER:-guest}:${RABBITMQ_PASS:-guest}@cityevents-rabbitmq:5672/
      - JWT_SECRET=${JWT_SECRET:?required}
      - REDIS_ENABLED=true
      - REDIS_URL=redis://cityevents-redis:6379/1
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/readyz" ]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  join-service:
    build:
      context: ./services/join-service
      dockerfile: Dockerfile
    ports:
      - "8083:8080"
    environment:
      - APP_ENV=${APP_ENV:-dev}
      - PORT=8080
      - DATABASE_URL=postgres://${POSTGRES_USER:?required}:${POSTGRES_PASSWORD:?required}@cityevents-postgres:5432/join_db?sslmode=disable
      - RABBITMQ_URL=amqp://${RABBITMQ_USER:-guest}:${RABBITMQ_PASS:-guest}@cityevents-rabbitmq:5672/
      - JWT_SECRET=${JWT_SECRET:?required}
      - REDIS_ADDR=cityevents-redis:6379
      - REDIS_DB=2
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/healthz" ]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 5s

    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  email-service:
    build:
      context: ./services/email-service
      dockerfile: Dockerfile
    ports:
      - "8090:8090"
    environment:
      - APP_ENV=${APP_ENV:-dev}
      - RABBIT_URL=amqp://${RABBITMQ_USER:-guest}:${RABBITMQ_PASS:-guest}@cityevents-rabbitmq:5672/
      - REDIS_ADDR=cityevents-redis:6379
      - REDIS_ENABLED=true
      - INTERNAL_SECRET_KEY=${INTERNAL_SECRET_KEY:?required}
      - SMTP_HOST=${SMTP_HOST:-mailpit}
      - SMTP_PORT=${SMTP_PORT:-1025}
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8090/readyz" ]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 5s
    depends_on:
      rabbitmq:
        condition: service_healthy

  feed-service:
    build:
      context: ./services/feed-service
      dockerfile: Dockerfile
    ports:
      - "8084:8084"
    environment:
      - APP_ENV=${APP_ENV:-dev}
      - HTTP_ADDR=:8084
      - DB_ADDR=postgres://${POSTGRES_USER:?required}:${POSTGRES_PASSWORD:?required}@cityevents-postgres:5432/feed_db?sslmode=disable
      - REDIS_ADDR=cityevents-redis:6379
      - REDIS_DB=3
      - RABBIT_URL=amqp://${RABBITMQ_USER:-guest}:${RABBITMQ_PASS:-guest}@cityevents-rabbitmq:5672/
      - ANON_COOKIE_SECRET=${ANON_COOKIE_SECRET:-dev-secret-change-in-prod}
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8084/api/feed/health" ]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 5s
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  media-service:
    build:
      context: ./services/media-service
      dockerfile: Dockerfile
    ports:
      - "8085:8085"
    environment:
      - APP_ENV=${APP_ENV:-dev}
      - HTTP_ADDR=:8085
      - DATABASE_URL=postgres://${POSTGRES_USER:?required}:${POSTGRES_PASSWORD:?required}@cityevents-postgres:5432/media_db?sslmode=disable
      - S3_ENDPOINT=http://cityevents-minio:9000
      - S3_EXTERNAL_ENDPOINT=http://localhost:9000
      - S3_ACCESS_KEY_ID=${MINIO_ROOT_USER:-minioadmin}
      - S3_SECRET_ACCESS_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - S3_USE_PATH_STYLE=true
      - S3_RAW_BUCKET=raw
      - S3_PUBLIC_BUCKET=public
      - CDN_BASE_URL=http://localhost:9000/public
      - RABBIT_URL=amqp://${RABBITMQ_USER:-guest}:${RABBITMQ_PASS:-guest}@cityevents-rabbitmq:5672/
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8085/readyz" ]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      minio:
        condition: service_healthy

  media-worker:
    build:
      context: ./services/media-worker
      dockerfile: Dockerfile
    environment:
      - APP_ENV=${APP_ENV:-dev}
      - DATABASE_URL=postgres://${POSTGRES_USER:?required}:${POSTGRES_PASSWORD:?required}@cityevents-postgres:5432/media_db?sslmode=disable
      - S3_ENDPOINT=http://cityevents-minio:9000
      - S3_ACCESS_KEY_ID=${MINIO_ROOT_USER:-minioadmin}
      - S3_SECRET_ACCESS_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - S3_USE_PATH_STYLE=true
      - S3_RAW_BUCKET=raw
      - S3_PUBLIC_BUCKET=public
      - RABBIT_URL=amqp://${RABBITMQ_USER:-guest}:${RABBITMQ_PASS:-guest}@cityevents-rabbitmq:5672/
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      minio:
        condition: service_healthy
      media-service:
        condition: service_healthy

  # -------------------------------------------------------------------------
  # API GATEWAY / BFF
  # -------------------------------------------------------------------------
  bff-service:
    build:
      context: ./services/bff-service
      dockerfile: Dockerfile
    ports:
      - "8080:8080" # Main API Entry
    environment:
      - APP_ENV=${APP_ENV:-dev}
      - HTTP_PORT=8080
      - CORS_ALLOWED_ORIGINS=http://localhost:5173,http://localhost:3000
      - AUTH_SERVICE_URL=http://auth-service:8080
      - EVENT_SERVICE_URL=http://event-service:8080
      - JOIN_SERVICE_URL=http://join-service:8080
      - FEED_SERVICE_URL=http://feed-service:8084
      - MEDIA_SERVICE_URL=http://media-service:8085
      - JWT_SECRET=${JWT_SECRET:?required}
      - INTERNAL_SECRET_KEY=${INTERNAL_SECRET_KEY:?required}
      - REDIS_ADDR=cityevents-redis:6379 # For distributed rate limiting
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/readyz" ]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

    depends_on:
      redis:
        condition: service_healthy
      auth-service:
        condition: service_healthy
      event-service:
        condition: service_healthy
      join-service:
        condition: service_healthy
      feed-service:
        condition: service_healthy
      media-service:
        condition: service_healthy

  # -------------------------------------------------------------------------
  # FRONTEND
  # -------------------------------------------------------------------------
  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
    ports:
      - "3000:80"
    depends_on:
      - bff-service
